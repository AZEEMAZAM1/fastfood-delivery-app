name: Build FastFood Delivery AAB

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create Android Project Structure
        run: |
          # Create directory structure
          mkdir -p app/src/main/java/com/fastfooddelivery
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-mdpi
          mkdir -p app/src/main/res/mipmap-xhdpi
          mkdir -p app/src/main/res/mipmap-xxhdpi
          mkdir -p app/src/main/res/mipmap-xxxhdpi
          mkdir -p gradle/wrapper

          # settings.gradle
          cat > settings.gradle << 'SETTINGS'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "FastFoodDelivery"
          include ':app'
          SETTINGS

          # Root build.gradle
          cat > build.gradle << 'BUILD'
          plugins {
              id 'com.android.application' version '8.2.0' apply false
          }
          BUILD

          # gradle.properties
          cat > gradle.properties << 'PROPS'
          android.useAndroidX=true
          org.gradle.jvmargs=-Xmx2048m
          PROPS

          # Gradle wrapper properties
          cat > gradle/wrapper/gradle-wrapper.properties << 'WRAPPER'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          WRAPPER

          # app/build.gradle
          cat > app/build.gradle << 'APPBUILD'
          plugins {
              id 'com.android.application'
          }

          android {
              namespace 'com.fastfooddelivery'
              compileSdk 34

              defaultConfig {
                  applicationId "com.fastfooddelivery"
                  minSdk 24
                  targetSdk 34
                  versionCode 1
                  versionName "1.0.0"
              }

              signingConfigs {
                  release {
                      storeFile file("${rootProject.projectDir}/keystore.jks")
                      storePassword "FastFood2025Secure"
                      keyAlias "fastfoodkey"
                      keyPassword "FastFood2025Secure"
                  }
              }

              buildTypes {
                  release {
                      minifyEnabled false
                      signingConfig signingConfigs.release
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }

          dependencies {
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.11.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
          }
          APPBUILD

          # AndroidManifest.xml
          cat > app/src/main/AndroidManifest.xml << 'MANIFEST'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:label="FastFood Delivery"
                  android:theme="@style/Theme.FastFoodDelivery">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          MANIFEST

          # MainActivity.java
          cat > app/src/main/java/com/fastfooddelivery/MainActivity.java << 'MAIN'
          package com.fastfooddelivery;

          import android.os.Bundle;
          import androidx.appcompat.app.AppCompatActivity;

          public class MainActivity extends AppCompatActivity {
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
              }
          }
          MAIN

          # activity_main.xml
          cat > app/src/main/res/layout/activity_main.xml << 'LAYOUT'
          <?xml version="1.0" encoding="utf-8"?>
          <androidx.constraintlayout.widget.ConstraintLayout
              xmlns:android="http://schemas.android.com/apk/res/android"
              xmlns:app="http://schemas.android.com/apk/res-auto"
              android:layout_width="match_parent"
              android:layout_height="match_parent">
              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="FastFood Delivery"
                  android:textSize="24sp"
                  app:layout_constraintBottom_toBottomOf="parent"
                  app:layout_constraintEnd_toEndOf="parent"
                  app:layout_constraintStart_toStartOf="parent"
                  app:layout_constraintTop_toTopOf="parent" />
          </androidx.constraintlayout.widget.ConstraintLayout>
          LAYOUT

          # colors.xml
          cat > app/src/main/res/values/colors.xml << 'COLORS'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <color name="orange_primary">#FF6B00</color>
              <color name="orange_dark">#E65100</color>
              <color name="white">#FFFFFF</color>
          </resources>
          COLORS

          # strings.xml
          cat > app/src/main/res/values/strings.xml << 'STRINGS'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">FastFood Delivery</string>
          </resources>
          STRINGS

          # themes.xml
          cat > app/src/main/res/values/themes.xml << 'THEMES'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <style name="Theme.FastFoodDelivery" parent="Theme.MaterialComponents.Light.NoActionBar">
                  <item name="colorPrimary">@color/orange_primary</item>
                  <item name="colorPrimaryDark">@color/orange_dark</item>
              </style>
          </resources>
          THEMES

          # Generate launcher icons using ImageMagick
          sudo apt-get install -y imagemagick
          for size in 48 72 96 144 192; do
            case $size in
              48) folder="mipmap-mdpi" ;;
              72) folder="mipmap-hdpi" ;;
              96) folder="mipmap-xhdpi" ;;
              144) folder="mipmap-xxhdpi" ;;
              192) folder="mipmap-xxxhdpi" ;;
            esac
            convert -size ${size}x${size} xc:"#FF6B00" \
              -gravity center -pointsize $((size/3)) -fill white \
              -annotate 0 "FF" \
              app/src/main/res/${folder}/ic_launcher.png
          done

      - name: Generate Keystore
        run: |
          keytool -genkeypair -v \
            -keystore keystore.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias fastfoodkey \
            -storepass FastFood2025Secure \
            -keypass FastFood2025Secure \
            -dname "CN=FastFood Delivery, OU=Development, O=FastFood, L=London, ST=England, C=GB"
          
          # Output SHA1 for Play Console
          echo "=== SHA1 Certificate Fingerprint ==="
          keytool -list -v -keystore keystore.jks -alias fastfoodkey -storepass FastFood2025Secure | grep SHA1
          echo "=== SHA256 Certificate Fingerprint ==="
          keytool -list -v -keystore keystore.jks -alias fastfoodkey -storepass FastFood2025Secure | grep SHA256

      - name: Make Gradle Wrapper
        run: |
          gradle wrapper --gradle-version 8.2
          chmod +x gradlew

      - name: Build Release AAB
        run: ./gradlew bundleRelease

      - name: Upload AAB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fastfood-delivery-release
          path: app/build/outputs/bundle/release/app-release.aab

      - name: Upload Keystore as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-keystore
          path: keystore.jks
